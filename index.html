<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upload Image to Google Drive</title>
</head>
<body>
    <h1>Upload Image to Google Drive</h1>
    <input type="file" id="fileInput" accept="image/*">
    <button id="uploadButton" disabled>Upload</button>
    <button id="authButton">Authorize</button>

    <script>
        const CLIENT_ID = 'YOUR_CLIENT_ID';
        const API_KEY = 'YOUR_API_KEY';
        const SCOPES = 'https://www.googleapis.com/auth/drive.file';

        async function loadAuthClient() {
            return new Promise((resolve, reject) => {
                gapi.load('client:auth2', async () => {
                    try {
                        await gapi.client.init({
                            apiKey: API_KEY,
                            clientId: CLIENT_ID,
                            scope: SCOPES,
                        });

                        const authInstance = gapi.auth2.getAuthInstance();
                        const isSignedIn = authInstance.isSignedIn.get();

                        document.getElementById('authButton').style.display = isSignedIn ? 'none' : 'block';
                        document.getElementById('uploadButton').disabled = !isSignedIn;

                        resolve();
                    } catch (error) {
                        console.error('Error initializing GAPI client:', error);
                        reject(error);
                    }
                });
            });
        }

        async function authenticate() {
            try {
                const authInstance = gapi.auth2.getAuthInstance();
                await authInstance.signIn();
                document.getElementById('authButton').style.display = 'none';
                document.getElementById('uploadButton').disabled = false;
            } catch (error) {
                if (error.error === 'popup_closed_by_user') {
                    console.warn('Authentication popup closed by user. Please try again.');
                } else {
                    console.error('Authentication failed:', error);
                }
            }
        }

        async function uploadFile(file) {
            try {
                const boundary = '-------314159265358979323846';
                const delimiter = `\r\n--${boundary}\r\n`;
                const closeDelimiter = `\r\n--${boundary}--`;

                const metadata = {
                    name: file.name,
                    mimeType: file.type,
                };

                const reader = new FileReader();
                reader.onload = async (e) => {
                    const fileData = e.target.result;

                    const multipartRequestBody =
                        delimiter +
                        'Content-Type: application/json\r\n\r\n' +
                        JSON.stringify(metadata) +
                        delimiter +
                        'Content-Type: ' +
                        file.type +
                        '\r\n\r\n' +
                        fileData +
                        closeDelimiter;

                    // Ensure the user is authenticated
                    const authInstance = gapi.auth2.getAuthInstance();
                    const isSignedIn = authInstance.isSignedIn.get();
                    if (!isSignedIn) {
                        console.warn('User is not authenticated. Please sign in first.');
                        return;
                    }

                    const response = await gapi.client.request({
                        path: 'https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart',
                        method: 'POST',
                        headers: {
                            'Content-Type': `multipart/related; boundary=${boundary}`,
                        },
                        body: multipartRequestBody,
                    });

                    if (response.status === 401) {
                        console.error('Unauthorized. Please check your credentials and authentication status.');
                    } else {
                        alert('File uploaded successfully: ' + response.result.id);
                    }
                };
                reader.readAsBinaryString(file);
            } catch (error) {
                console.error('File upload failed:', error);
            }
        }

        document.getElementById('uploadButton').addEventListener('click', async () => {
            const fileInput = document.getElementById('fileInput');
            if (!fileInput.files.length) {
                alert('Please select a file first!');
                return;
            }
            const file = fileInput.files[0];
            try {
                await uploadFile(file);
            } catch (error) {
                console.error('Error:', error);
            }
        });

        document.getElementById('authButton').addEventListener('click', authenticate);

        // Load the Google API script
        const script = document.createElement('script');
        script.src = 'https://apis.google.com/js/api.js';
        script.onload = loadAuthClient;
        document.body.appendChild(script);
    </script>
</body>
</html>
